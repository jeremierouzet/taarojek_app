{% extends "device_sync/base.html" %}

{% block title %}Device Sync - {{ instance.name }}{% endblock %}

{% block extra_css %}
<style>
    .sync-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #FF9800 0%, #f57c00 100%);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .device-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .device-table th,
    .device-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--swisscom-gray);
    }
    
    .device-table th {
        background-color: #f5f5f5;
        font-weight: bold;
        color: var(--swisscom-blue);
    }
    
    .device-table tr:hover {
        background-color: #f9f9f9;
    }
    
    .connection-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 2rem;
    }
    
    .device-selection-panel {
        background-color: #f9f9f9;
        border: 1px solid var(--swisscom-gray);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .device-list {
        max-height: 300px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .device-checkbox {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        cursor: pointer;
    }
    
    .device-checkbox:hover {
        background-color: #e8e8e8;
        border-radius: 4px;
    }
    
    .device-checkbox input[type="checkbox"] {
        margin-right: 0.5rem;
        cursor: pointer;
    }
    
    .selection-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="sync-header">
        <div>
            <h1>Device Synchronization</h1>
            <p style="color: {{ instance.color }}; font-weight: bold;">{{ instance.name }}</p>
        </div>
        <div>
            <a href="{% url 'device_sync:index' %}" class="btn btn-primary">‚Üê Back to Instances</a>
        </div>
    </div>
    
    {% if not is_connected %}
    <div class="connection-warning">
        <strong>‚ö†Ô∏è Not Connected</strong><br>
        Please connect to this NSO instance first from the main page.
    </div>
    {% else %}
    
    <div class="device-selection-panel">
        <h2>Device Selection</h2>
        <p style="color: #666; font-size: 0.875rem;">Select one or more devices to check, or select all devices.</p>
        
        <div id="device-loading" class="alert alert-info">
            <span class="loading"></span> Loading device list...
        </div>
        
        <div id="device-selection-content" style="display: none;">
            <div class="selection-controls">
                <button class="btn btn-small" onclick="selectAll()">‚úì Select All</button>
                <button class="btn btn-small" onclick="deselectAll()">‚úó Deselect All</button>
                <span id="selected-count" style="margin-left: 1rem; color: var(--swisscom-blue); font-weight: bold;">0 selected</span>
            </div>
            
            <div class="device-list" id="device-list">
                <!-- Device checkboxes will be populated here -->
            </div>
        </div>
        
        <div id="device-error" class="alert alert-error" style="display: none;"></div>
    </div>
    
    <div id="sync-results" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-devices">-</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="in-sync-count">-</div>
                <div class="stat-label">In Sync</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="out-sync-count">-</div>
                <div class="stat-label">Out of Sync</div>
            </div>
        </div>
        
        <div class="card-header">
            <h2>Device Details</h2>
        </div>
        
        <table class="device-table">
            <thead>
                <tr>
                    <th>Device Name</th>
                    <th>Sync Status</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody id="device-table-body">
            </tbody>
        </table>
    </div>
    
    <div id="loading-indicator" class="alert alert-info" style="display: none;">
        <span class="loading"></span> Checking device synchronization status...
    </div>
    
    <div id="error-message" class="alert alert-error" style="display: none;"></div>
    
    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="checkSync()" id="check-sync-btn">
            üîÑ Check Sync Status
        </button>
        <button class="btn btn-secondary" onclick="syncFrom()" id="sync-from-btn" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
            ‚¨áÔ∏è Sync From Devices
        </button>
        <button class="btn btn-secondary" onclick="syncTo()" id="sync-to-btn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
            ‚¨ÜÔ∏è Sync To Devices
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if is_connected %}
let allDevices = [];

// Load devices on page load
window.onload = function() {
    loadDevices();
};

function loadDevices() {
    const loading = document.getElementById('device-loading');
    const content = document.getElementById('device-selection-content');
    const error = document.getElementById('device-error');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
    
    fetch('/api/get-devices/{{ instance_name }}/')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                allDevices = data.devices;
                renderDeviceList(allDevices);
                content.style.display = 'block';
            } else {
                error.textContent = '‚úó ' + data.message;
                error.style.display = 'block';
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            error.textContent = '‚úó Failed to load devices: ' + err;
            error.style.display = 'block';
        });
}

function renderDeviceList(devices) {
    const deviceList = document.getElementById('device-list');
    deviceList.innerHTML = '';
    
    devices.forEach((device, index) => {
        const label = document.createElement('label');
        label.className = 'device-checkbox';
        label.innerHTML = `
            <input type="checkbox" 
                   id="device-${index}" 
                   value="${device.name}" 
                   onchange="updateSelectedCount()">
            <span>${device.name}</span>
        `;
        deviceList.appendChild(label);
    });
    
    updateSelectedCount();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.device-checkbox input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.device-checkbox input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.device-checkbox input[type="checkbox"]:checked');
    const count = checkboxes.length;
    document.getElementById('selected-count').textContent = `${count} selected`;
    
    // Update button texts
    const checkBtn = document.getElementById('check-sync-btn');
    const syncFromBtn = document.getElementById('sync-from-btn');
    const syncToBtn = document.getElementById('sync-to-btn');
    
    if (count === 0) {
        checkBtn.textContent = 'üîÑ Check All Devices';
        syncFromBtn.textContent = '‚¨áÔ∏è Sync From All Devices';
        syncToBtn.textContent = '‚¨ÜÔ∏è Sync To All Devices';
    } else if (count === allDevices.length) {
        checkBtn.textContent = `üîÑ Check All ${count} Devices`;
        syncFromBtn.textContent = `‚¨áÔ∏è Sync From All ${count} Devices`;
        syncToBtn.textContent = `‚¨ÜÔ∏è Sync To All ${count} Devices`;
    } else {
        checkBtn.textContent = `üîÑ Check ${count} Selected Device${count > 1 ? 's' : ''}`;
        syncFromBtn.textContent = `‚¨áÔ∏è Sync From ${count} Device${count > 1 ? 's' : ''}`;
        syncToBtn.textContent = `‚¨ÜÔ∏è Sync To ${count} Device${count > 1 ? 's' : ''}`;
    }
}

function getSelectedDevices() {
    const checkboxes = document.querySelectorAll('.device-checkbox input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function checkSync() {
    const loading = document.getElementById('loading-indicator');
    const error = document.getElementById('error-message');
    const results = document.getElementById('sync-results');
    
    loading.style.display = 'block';
    error.style.display = 'none';
    results.style.display = 'none';
    
    // Get selected devices
    const selectedDevices = getSelectedDevices();
    
    // Prepare request
    const requestOptions = {
        method: selectedDevices.length > 0 ? 'POST' : 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    };
    
    if (selectedDevices.length > 0) {
        requestOptions.body = JSON.stringify({
            devices: selectedDevices
        });
    }
    
    fetch('/api/check-sync/{{ instance_name }}/', requestOptions)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                // Update stats
                document.getElementById('total-devices').textContent = data.total_devices;
                document.getElementById('in-sync-count').textContent = data.in_sync;
                document.getElementById('out-sync-count').textContent = data.out_of_sync;
                
                // Update table
                const tbody = document.getElementById('device-table-body');
                tbody.innerHTML = '';
                
                data.results.forEach(device => {
                    const row = document.createElement('tr');
                    const statusClass = device.in_sync ? 'status-in-sync' : 'status-out-sync';
                    const statusText = device.in_sync ? '‚úì In Sync' : '‚ö† Out of Sync';
                    
                    row.innerHTML = `
                        <td><strong>${device.device}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${device.sync_result || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                results.style.display = 'block';
            } else {
                error.textContent = '‚úó ' + data.message;
                error.style.display = 'block';
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            error.textContent = '‚úó Failed to check sync status: ' + err;
            error.style.display = 'block';
        });
}

function syncFrom() {
    const selectedDevices = getSelectedDevices();
    
    if (selectedDevices.length === 0 && allDevices.length > 10) {
        if (!confirm(`This will sync FROM all ${allDevices.length} devices. This may take some time. Continue?`)) {
            return;
        }
    } else if (selectedDevices.length > 0) {
        if (!confirm(`This will sync FROM ${selectedDevices.length} device(s). Continue?`)) {
            return;
        }
    }
    
    performSync('from', selectedDevices);
}

function syncTo() {
    const selectedDevices = getSelectedDevices();
    
    if (selectedDevices.length === 0 && allDevices.length > 10) {
        if (!confirm(`‚ö†Ô∏è WARNING: This will sync TO all ${allDevices.length} devices, overwriting their configurations. Continue?`)) {
            return;
        }
    } else if (selectedDevices.length > 0) {
        if (!confirm(`‚ö†Ô∏è WARNING: This will sync TO ${selectedDevices.length} device(s), overwriting their configurations. Continue?`)) {
            return;
        }
    }
    
    performSync('to', selectedDevices);
}

function performSync(direction, selectedDevices) {
    const loading = document.getElementById('loading-indicator');
    const error = document.getElementById('error-message');
    const results = document.getElementById('sync-results');
    
    // Update loading message
    const actionText = direction === 'from' ? 'Syncing FROM devices TO NSO' : 'Syncing TO devices FROM NSO';
    loading.innerHTML = `<span class="loading"></span> ${actionText}... This may take a while.`;
    loading.style.display = 'block';
    error.style.display = 'none';
    results.style.display = 'none';
    
    // Prepare request
    const endpoint = direction === 'from' ? '/api/sync-from/{{ instance_name }}/' : '/api/sync-to/{{ instance_name }}/';
    const requestOptions = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            devices: selectedDevices.length > 0 ? selectedDevices : allDevices.map(d => d.name)
        })
    };
    
    fetch(endpoint, requestOptions)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                // Show results in a table format
                const stats = data.stats;
                const directionText = direction === 'from' ? 'FROM devices' : 'TO devices';
                
                // Update stats
                document.getElementById('total-devices').textContent = stats.total;
                document.getElementById('in-sync-count').textContent = stats.successful;
                document.getElementById('out-sync-count').textContent = stats.failed;
                
                // Update stat labels
                document.querySelector('#in-sync-count').parentElement.querySelector('.stat-label').textContent = 'Successful';
                document.querySelector('#out-sync-count').parentElement.querySelector('.stat-label').textContent = 'Failed';
                
                // Update table header
                document.querySelector('.card-header h2').textContent = `Sync ${direction.toUpperCase()} Results`;
                
                // Update table
                const tbody = document.getElementById('device-table-body');
                tbody.innerHTML = '';
                
                data.results.forEach(result => {
                    const row = document.createElement('tr');
                    const statusClass = result.success ? 'status-in-sync' : 'status-out-sync';
                    const statusText = result.success ? '‚úì Success' : '‚úó Failed';
                    const message = result.message || result.error || 'N/A';
                    
                    row.innerHTML = `
                        <td><strong>${result.device}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${message}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                results.style.display = 'block';
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-info';
                successMsg.textContent = `‚úì ${data.message}`;
                successMsg.style.marginTop = '1rem';
                results.insertBefore(successMsg, results.firstChild);
                
                // Auto-remove success message after 5 seconds
                setTimeout(() => successMsg.remove(), 5000);
            } else {
                error.textContent = '‚úó ' + data.message;
                error.style.display = 'block';
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            error.textContent = '‚úó Sync operation failed: ' + err;
            error.style.display = 'block';
        });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
{% endif %}
</script>
{% endblock %}
